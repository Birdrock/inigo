#!/bin/bash

set -e -x

DEV_GOPATH=$(cd ${1:-$HOME/go} && pwd)
TMP_GOPATH=/tmp/inigo

mkdir -p ${TMP_GOPATH}

cp $(dirname $0)/.drone.yml ${TMP_GOPATH}/.drone.yml

function copy_to_gopath {
  mkdir -p ${TMP_GOPATH}/src/${1}
  rsync --del --exclude '.*' -a ${DEV_GOPATH}/src/${1}/ ${TMP_GOPATH}/src/${1}/
}

pushd $TMP_GOPATH
  go get \
    github.com/cloudfoundry-incubator/inigo/...\
    github.com/cloudfoundry-incubator/executor/... \
    github.com/cloudfoundry-incubator/stager/... \
    github.com/cloudfoundry-incubator/file-server/... \
    github.com/cloudfoundry-incubator/linux-smelter/... \
    github.com/pivotal-cf-experimental/garden/...

  godep save \
    github.com/cloudfoundry-incubator/inigo/...\
    github.com/cloudfoundry-incubator/executor/... \
    github.com/cloudfoundry-incubator/stager/... \
    github.com/cloudfoundry-incubator/file-server/... \
    github.com/cloudfoundry-incubator/linux-smelter/... \
    github.com/pivotal-cf-experimental/garden/...

  rsync --del --exclude '.*' -a Godeps/_workspace/src/ src/
  rm -rf Godeps
popd

# grab and set up our components
for package in \
    github.com/cloudfoundry-incubator/inigo \
    github.com/cloudfoundry-incubator/executor \
    github.com/cloudfoundry-incubator/stager \
    github.com/cloudfoundry-incubator/file-server \
    github.com/cloudfoundry-incubator/linux-smelter \
    github.com/pivotal-cf-experimental/garden; do
  copy_to_gopath $package &
done

# install application dependencies
for package in github.com/coreos/etcd github.com/apcera/gnatsd; do
  copy_to_gopath $package &
done

rsync --del --exclude '.*' -a ~/workspace/loggregator/ ${TMP_GOPATH}/loggregator/ &

wait

drone -privileged build $TMP_GOPATH
